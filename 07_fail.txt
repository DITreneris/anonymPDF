(venv) PS C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF> pytest
================================================= test session starts =================================================
platform win32 -- Python 3.11.9, pytest-7.4.3, pluggy-1.6.0
benchmark: 4.0.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF
configfile: pytest.ini
testpaths: tests
plugins: anyio-3.7.1, hypothesis-6.92.1, asyncio-0.21.1, benchmark-4.0.0, cov-4.1.0, mock-3.12.0
asyncio: mode=Mode.STRICT
collected 354 items

tests\test_analytics_api.py .......................                                                              [  6%]
tests\test_analytics_engine.py .....F                                                                            [  8%]
tests\test_config_manager.py ...F.........                                                                       [ 11%]
tests\test_feedback_system.py ...................F.                                                              [ 17%]
tests\test_intelligent_cache.py ....................F.......F                                                    [ 25%]
tests\test_memory_optimizer.py ..............................F                                                   [ 34%]
tests\test_ml_integration_layer.py .........                                                                     [ 37%]
tests\test_morning_ses5_improvements.py .........F..FF                                                           [ 41%]
tests\test_pdf_processor.py .FFF                                                                                 [ 42%]
tests\test_performance.py ..............                                                                         [ 46%]
tests\test_performance_enhanced.py .............FFF.F....F..FC:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\venv\Lib\site-packages\_pytest\threadexception.py:73: PytestUnhandledThreadExceptionWarning: Exception in thread Thread-36 (processing_task)

Traceback (most recent call last):
  File "C:\Users\tomas\AppData\Local\Programs\Python\Python311\Lib\threading.py", line 1045, in _bootstrap_inner
    self.run()
  File "C:\Users\tomas\AppData\Local\Programs\Python\Python311\Lib\threading.py", line 982, in run
    self._target(*self._args, **self._kwargs)
  File "C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\tests\test_performance_enhanced.py", line 526, in processing_task
    processor.process_files([file_path], f"session_{file_index}")
    ^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'PerformanceOptimizedProcessor' object has no attribute 'process_files'

  warnings.warn(pytest.PytestUnhandledThreadExceptionWarning(msg))
FF                                                  [ 54%]
tests\test_performance_optimizer.py ...................FF                                                        [ 60%]
tests\test_pii_patterns.py .............                                                                         [ 63%]
tests\test_priority2_enhancements.py .............................                                               [ 72%]
tests\test_real_time_monitor.py .........F........F....F.......                                                  [ 80%]
tests\test_training_data_collector.py .FF.....F                                                                  [ 83%]
tests\test_validation_utils.py ...F..................                                                            [ 89%]
tests\adaptive\test_ab_testing.py ......F.                                                                       [ 91%]
tests\adaptive\test_doc_classifier.py ........                                                                   [ 94%]
tests\adaptive\test_online_learner.py ....FF                                                                     [ 95%]
tests\adaptive\test_pattern_db.py ......                                                                         [ 97%]
tests\adaptive\test_pattern_learner.py .F                                                                        [ 98%]
tests\adaptive\test_processing_rules.py ....                                                                     [ 99%]
tests\system\test_adaptive_workflow.py EEE                                                                       [100%]

======================================================= ERRORS ========================================================
_______________________________________ ERROR at setup of test_fixture_creation _______________________________________
tests\system\test_adaptive_workflow.py:86: in adaptive_system_fixture
    ab_manager = ABTestManager(db_path=AB_TEST_DB_PATH)
app\core\adaptive\ab_testing.py:94: in __init__
    self.db_path.parent.mkdir(parents=True, exist_ok=True)
E   AttributeError: 'str' object has no attribute 'parent'
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:12:11,579 - anonympdf.ml_monitoring - INFO - ML Performance Monitor initialized
2025-06-12 21:12:11,579 - anonympdf.anonympdf.analytics - INFO - QualityAnalyzer initialized - {"extra": {"db_path": "data\\temp_test_dbs\\analytics_716d28f5f2d846f290f3145b7c0ae27d.db"}}
______________________ ERROR at setup of test_feedback_creates_pattern_and_overrides_prediction _______________________
tests\system\test_adaptive_workflow.py:86: in adaptive_system_fixture
    ab_manager = ABTestManager(db_path=AB_TEST_DB_PATH)
app\core\adaptive\ab_testing.py:94: in __init__
    self.db_path.parent.mkdir(parents=True, exist_ok=True)
E   AttributeError: 'str' object has no attribute 'parent'
__________________________________ ERROR at setup of test_ab_testing_full_lifecycle ___________________________________
tests\system\test_adaptive_workflow.py:86: in adaptive_system_fixture
    ab_manager = ABTestManager(db_path=AB_TEST_DB_PATH)
app\core\adaptive\ab_testing.py:94: in __init__
    self.db_path.parent.mkdir(parents=True, exist_ok=True)
E   AttributeError: 'str' object has no attribute 'parent'
====================================================== FAILURES =======================================================
___________________________ TestQualityInsightsGenerator.test_generate_report_with_insights ___________________________
tests\test_analytics_engine.py:114: in test_generate_report_with_insights
    assert "summary" in report and "insights" in report
E   AssertionError: assert ('summary' in {'insights': [], 'quality_summary': {'by_category': {'EMAIL': {'avg_confidence': 0.9, 'total_detections': 5}, 'PHONE': {'avg_confidence': 0.7, 'total_detections': 5}}, 'overall': {'avg_confidence': 0.8, 'total_detections': 10}}})
___________________________________ TestConfigManager.test_configuration_validation ___________________________________
tests\test_config_manager.py:67: in test_configuration_validation
    assert is_valid is True
E   assert False is True
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:10:51,793 - config_manager - WARNING - Configuration validation failed - {"error_count": 10, "errors": ["Missing required setting: version", "Missing required setting: language_detection", "Missing required setting: processing", "Missing required setting: logging", "Missing required setting: anti_overredaction", "Missing required adaptive learning setting: enabled", "Missing required adaptive learning setting: databases", "Missing required adaptive learning setting: thresholds", "Missing required adaptive learning setting: performance", "Missing required adaptive learning setting: monitoring"]}
_____________________ TestFeedbackSystemIntegration.test_feedback_submission_and_processing_flow ______________________
tests\test_feedback_system.py:499: in test_feedback_submission_and_processing_flow
    with patch.object(self.system.training_data_collector, 'save_training_examples') as mock_save:
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:1446: in __enter__
    original, local = self.get_original()
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <app.core.training_data.TrainingDataCollector object at 0x0000025394CA4E50> does not have the attribute 'save_training_examples'
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:30,132 - anonympdf.anonympdf.feedback_system - INFO - FeedbackAnalyzer initialized
2025-06-12 21:11:30,132 - anonympdf.anonympdf.feedback_system - INFO - UserFeedbackProcessor initialized
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:30,132 - anonympdf.anonympdf.feedback_system - INFO - Feedback submitted: false_positive for ADDRESS - {"feedback_id": "integration_test_001", "document_id": "doc_1"}
____________________________________ TestIntelligentCache.test_comprehensive_stats ____________________________________
tests\test_intelligent_cache.py:396: in test_comprehensive_stats
    assert stats['general']['hits'] == 1
E   KeyError: 'general'
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:33,773 - anonympdf.intelligent_cache - INFO - Cache cleared
2025-06-12 21:11:33,773 - anonympdf.intelligent_cache - INFO - Cache cleared
2025-06-12 21:11:33,773 - anonympdf.intelligent_cache - INFO - Cache cleared
2025-06-12 21:11:33,789 - anonympdf.intelligent_cache - INFO - All caches cleared
_________________________________________ TestConcurrency.test_thread_safety __________________________________________
tests\test_intelligent_cache.py:561: in test_thread_safety
    assert stats['general']['size'] == 100
E   KeyError: 'general'
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:34,284 - anonympdf.intelligent_cache - INFO - Cache cleared
2025-06-12 21:11:34,284 - anonympdf.intelligent_cache - INFO - Cache cleared
2025-06-12 21:11:34,284 - anonympdf.intelligent_cache - INFO - Cache cleared
2025-06-12 21:11:34,284 - anonympdf.intelligent_cache - INFO - All caches cleared
___________________________________ TestIntegration.test_memory_threshold_handling ____________________________________
tests\test_memory_optimizer.py:700: in test_memory_threshold_handling
    assert len(high_mem_calls) > 0, "MemoryMonitor should log a warning for high memory usage"
E   AssertionError: MemoryMonitor should log a warning for high memory usage
E   assert 0 > 0
E    +  where 0 = len([])
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:39,965 - anonympdf.memory_optimizer - INFO - GarbageCollectionManager initialized
2025-06-12 21:11:39,965 - anonympdf.memory_optimizer - INFO - MemoryMonitor initialized
2025-06-12 21:11:39,965 - anonympdf.memory_optimizer - INFO - MemoryOptimizer initialized. Config: {'cache_size': 1000, 'cache_ttl_seconds': 3600, 'max_workers': 4, 'parallel_processing': {'max_workers': 4, 'chunk_size': 100}, 'batch_engine': {'max_batch_size': 100, 'batch_timeout_seconds': 10}}
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:39,965 - anonympdf.memory_optimizer - INFO - MemoryOptimizer.start_optimization() called. Starting memory monitoring.
2025-06-12 21:11:40,019 - anonympdf.memory_optimizer - INFO - Memory monitoring started
2025-06-12 21:11:40,094 - anonympdf.memory_optimizer - INFO - Memory baseline set - {"baseline_mb": 100.0}
---------------------------------------------- Captured stderr teardown -----------------------------------------------
2025-06-12 21:11:40,288 - anonympdf.memory_optimizer - WARNING - High memory usage detected - {"memory_percent": 75.0, "rss_mb": 100.0}
2025-06-12 21:11:40,366 - anonympdf.memory_optimizer - INFO - MemoryOptimizer.stop_optimization() called. Stopping memory monitoring.
2025-06-12 21:11:40,366 - anonympdf.memory_optimizer - WARNING - Critical memory usage detected - {"memory_percent": 93.2, "rss_mb": 2887.609375}
2025-06-12 21:11:40,379 - anonympdf.memory_optimizer - INFO - Memory monitoring stopped
_____________________ TestMorningSes5AntiOverredaction.test_no_preserve_pii_in_technical_sections _____________________
tests\test_morning_ses5_improvements.py:210: in test_no_preserve_pii_in_technical_sections
    assert not processor.should_preserve_detection(
E   AssertionError: assert not True
E    +  where True = <bound method PDFProcessor.should_preserve_detection of <app.services.pdf_processor.PDFProcessor object at 0x00000253DBD9B5D0>>('38901234567', 'lithuanian_personal_code', 'SVORIS: Asmens kodas: 38901234567')
E    +    where <bound method PDFProcessor.should_preserve_detection of <app.services.pdf_processor.PDFProcessor object at 0x00000253DBD9B5D0>> = <app.services.pdf_processor.PDFProcessor object at 0x00000253DBD9B5D0>.should_preserve_detection
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:44,986 - anonympdf.pdf - INFO - Initializing PDF processor with Priority 2 enhancements
2025-06-12 21:11:45,017 - config_manager - INFO - Patterns loaded from file - {"file": "config\\patterns.yaml", "patterns_count": 37}
2025-06-12 21:11:45,017 - config_manager - INFO - Cities loaded from file - {"file": "config\\cities.yaml", "cities_count": 79}
2025-06-12 21:11:45,033 - config_manager - INFO - Settings loaded from file - {"file": "config\\settings.yaml"}
2025-06-12 21:11:45,033 - config_manager - INFO - Configuration manager initialized - {"config_dir": "config", "patterns_count": 37, "cities_count": 79}
2025-06-12 21:11:45,049 - anonympdf.pdf - INFO - Configuration manager loaded - {"patterns_count": 37, "cities_count": 79}
2025-06-12 21:11:45,049 - anonympdf.pdf - INFO - Priority 2 context-aware components initialized
2025-06-12 21:11:45,930 - anonympdf.pdf - INFO - English spaCy model loaded successfully - {"model": "en_core_web_sm", "components": 6, "method": "standard"}
2025-06-12 21:11:46,401 - anonympdf.pdf - INFO - Lithuanian spaCy model loaded successfully - {"model": "lt_core_news_sm", "components": 7, "method": "standard"}
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:46,401 - anonympdf.pdf - INFO - Detection preserved due to technical term context - {"text": "38901234567", "pattern_type": "lithuanian_personal_code", "technical_term": "SVORIS"}
____________________ TestMorningSes5Integration.test_comprehensive_lithuanian_document_processing _____________________
tests\test_morning_ses5_improvements.py:263: in test_comprehensive_lithuanian_document_processing
    assert len(personal_info["names"]) >= 1, "Should detect STANIULIS TOMAS"
E   KeyError: 'names'
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:48,844 - anonympdf.pdf - INFO - Using Lithuanian NLP model for processing
2025-06-12 21:11:48,881 - anonympdf.pdf - INFO - Detection preserved due to technical term context - {"text": "Vilei\u0161io g. 11-4", "pattern_type": "lithuanian_address_generic", "technical_term": "kW"}
2025-06-12 21:11:48,881 - anonympdf.pdf - INFO - Detection preserved due to technical term context - {"text": "Adresas: P. Vilei\u0161io g. 11-4", "pattern_type": "lithuanian_address_prefixed", "technical_term": "kW"}
2025-06-12 21:11:48,897 - anonympdf.performance - INFO - Performance tracking: pii_detection - {"duration": 0.05337977409362793, "memory_delta": -2.3125, "function": "find_personal_info"}
_______________________ TestMorningSes5Integration.test_anti_overredaction_in_technical_context _______________________
tests\test_morning_ses5_improvements.py:299: in test_anti_overredaction_in_technical_context
    assert len(personal_info["names"]) >= 1, "Should detect name"
E   KeyError: 'names'
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:48,913 - anonympdf.pdf - INFO - Using Lithuanian NLP model for processing
2025-06-12 21:11:48,928 - anonympdf.pdf - INFO - Detection preserved due to technical term context - {"text": "38901234567", "pattern_type": "eleven_digit_numeric", "technical_term": "kW"}
2025-06-12 21:11:48,928 - anonympdf.pdf - INFO - Detection preserved due to technical term context - {"text": "38901234567", "pattern_type": "health_insurance_number", "technical_term": "kW"}
2025-06-12 21:11:48,928 - anonympdf.pdf - INFO - Detection preserved due to technical term context - {"text": "38901234567", "pattern_type": "lithuanian_personal_code", "technical_term": "kW"}
2025-06-12 21:11:48,928 - anonympdf.pdf - INFO - Detection preserved due to technical term context - {"text": "asmens kodas: 38901234567", "pattern_type": "lithuanian_personal_code_contextual", "technical_term": "kW"}
2025-06-12 21:11:48,928 - anonympdf.performance - INFO - Performance tracking: pii_detection - {"duration": 0.015621423721313477, "memory_delta": 0.01953125, "function": "find_personal_info"}
_______________________________________________ test_find_personal_info _______________________________________________
tests\test_pdf_processor.py:43: in test_find_personal_info
    personal_info = pdf_processor.find_personal_info(sample_text, language="en")
app\core\performance.py:576: in wrapper
    result = func(*args, **kwargs)
app\services\pdf_processor.py:339: in find_personal_info
    matches = re.finditer(current_regex_text, text)
..\..\..\AppData\Local\Programs\Python\Python311\Lib\re\__init__.py:223: in finditer
    return _compile(pattern, flags).finditer(string)
..\..\..\AppData\Local\Programs\Python\Python311\Lib\re\__init__.py:277: in _compile
    return _cache[type(pattern), pattern, flags]
E   TypeError: unhashable type: 'list'
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:50,481 - anonympdf.pdf - INFO - Using English NLP model for processing - {"language": "en"}
2025-06-12 21:11:50,951 - anonympdf.performance - INFO - Performance tracking: pii_detection - {"duration": 0.47011828422546387, "memory_delta": -367.12109375, "function": "find_personal_info"}
___________________________________________ test_generate_redaction_report ____________________________________________
tests\test_pdf_processor.py:61: in test_generate_redaction_report
    personal_info = pdf_processor.find_personal_info(sample_text, language="en")
app\core\performance.py:576: in wrapper
    result = func(*args, **kwargs)
app\services\pdf_processor.py:339: in find_personal_info
    matches = re.finditer(current_regex_text, text)
..\..\..\AppData\Local\Programs\Python\Python311\Lib\re\__init__.py:223: in finditer
    return _compile(pattern, flags).finditer(string)
..\..\..\AppData\Local\Programs\Python\Python311\Lib\re\__init__.py:277: in _compile
    return _cache[type(pattern), pattern, flags]
E   TypeError: unhashable type: 'list'
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:50,998 - anonympdf.pdf - INFO - Using English NLP model for processing - {"language": "en"}
2025-06-12 21:11:50,998 - anonympdf.performance - INFO - Performance tracking: pii_detection - {"duration": 0.0, "memory_delta": 0.0859375, "function": "find_personal_info"}
_____________________________________ test_process_pdf_failure_on_invalid_content _____________________________________
tests\test_pdf_processor.py:94: in test_process_pdf_failure_on_invalid_content
    assert "Failed to open document" in result["error"]
E   AssertionError: assert 'Failed to open document' in 'An exception occurred during anonymization'
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:51,052 - anonympdf.pdf - INFO - Starting PDF processing - {"filename": "C:\\Users\\tomas\\AppData\\Local\\Temp\\pytest-of-tomas\\pytest-33\\test_process_pdf_failure_on_in0\\test.pdf"}
2025-06-12 21:11:51,052 - anonympdf.pdf - INFO - File copied to temp directory - {"filename": "test.pdf", "temp_path": "temp\\test.pdf", "file_size": 52}
2025-06-12 21:11:51,052 - anonympdf.pdf - INFO - Starting PDF anonymization - {"input_path": "temp\\test.pdf", "output_path": "processed\\anonymized_test.pdf"}
2025-06-12 21:11:51,052 - anonympdf.performance - INFO - Performance tracking: text_extraction - {"duration": 0.0, "memory_delta": 0.0078125, "function": "extract_text_from_pdf"}
2025-06-12 21:11:51,052 - anonympdf.pdf - ERROR - Error in anonymize_pdf: TypeError - Logger._log() got an unexpected keyword argument 'error' - {"input_path": "temp\\test.pdf", "output_path": "processed\\anonymized_test.pdf"}
Traceback (most recent call last):
  File "C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\app\core\text_extraction.py", line 63, in extract_text_robust
    text = method_func(pdf_path)
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\app\core\text_extraction.py", line 112, in _extract_with_pymupdf
    doc = fitz.open(str(pdf_path))
          ^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\tomas\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py", line 1124, in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\tomas\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py", line 1128, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\tomas\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py", line 1183, in _execute_mock_call
    raise effect
RuntimeError: Failed to open document

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\app\services\pdf_processor.py", line 582, in anonymize_pdf
    text = self.extract_text_from_pdf(input_path)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\app\core\performance.py", line 576, in wrapper
    result = func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\app\services\pdf_processor.py", line 791, in extract_text_from_pdf
    return extract_text_enhanced(pdf_path)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\app\core\intelligent_cache.py", line 641, in wrapper
    result = func(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\app\core\text_extraction.py", line 340, in extract_text_enhanced
    return enhanced_extractor.extract_text_robust(pdf_path)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\app\core\text_extraction.py", line 86, in extract_text_robust
    extraction_logger.warning(
  File "C:\Users\tomas\AppData\Local\Programs\Python\Python311\Lib\logging\__init__.py", line 1501, in warning
    self._log(WARNING, msg, args, **kwargs)
TypeError: Logger._log() got an unexpected keyword argument 'error'
2025-06-12 21:11:51,052 - anonympdf.pdf - ERROR - BENCHMARK: anonymize_pdf for test.pdf failed after 0.0000 seconds.
2025-06-12 21:11:51,052 - anonympdf.pdf - ERROR - PDF processing failed - {"filename": "test.pdf", "error": "An exception occurred during anonymization", "processing_time": 0.0}
2025-06-12 21:11:51,052 - anonympdf.performance - INFO - Performance tracking: pdf_processing - {"duration": 0.0, "memory_delta": 0.04296875, "file_size_mb": 4.9591064453125e-05, "file_extension": ".pdf", "operation_type": "pdf_processing"}
2025-06-12 21:11:51,052 - anonympdf.pdf - INFO - Temporary file cleaned up - {"temp_path": "temp\\test.pdf"}
-------------------------------------------------- Captured log call --------------------------------------------------
ERROR    app.core.text_extraction:text_extraction.py:127 PyMuPDF extraction failed: Failed to open document
___________________________ TestPerformanceOptimizedProcessor.test_processor_initialization ___________________________
tests\test_performance_enhanced.py:335: in test_processor_initialization
    assert self.processor.parallel_processor is not None
E   AttributeError: 'PerformanceOptimizedProcessor' object has no attribute 'parallel_processor'
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:52,658 - anonympdf.performance - INFO - Performance optimizers loaded successfully
_________________________ TestPerformanceOptimizedProcessor.test_optimized_processing_session _________________________
tests\test_performance_enhanced.py:342: in test_optimized_processing_session
    session = processor.create_session("optimized_test")
E   AttributeError: 'PerformanceOptimizedProcessor' object has no attribute 'create_session'
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:52,674 - anonympdf.performance - INFO - Performance optimizers loaded successfully
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:52,674 - anonympdf.performance - INFO - Performance optimizers loaded successfully
___________________________ TestPerformanceOptimizedProcessor.test_parallel_file_processing ___________________________
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:918: in assert_called_once
    raise AssertionError(msg)
E   AssertionError: Expected 'map' to have been called once. Called 0 times.

During handling of the above exception, another exception occurred:
tests\test_performance_enhanced.py:376: in test_parallel_file_processing
    mock_executor_instance.map.assert_called_once()
E   AssertionError: Expected 'map' to have been called once. Called 0 times.
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:52,689 - anonympdf.performance - INFO - Performance optimizers loaded successfully
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:52,705 - anonympdf.performance - INFO - Parallel session started - {"session_id": "parallel_file_processing_1749751912", "worker_count": 2}
2025-06-12 21:11:52,705 - anonympdf.performance_optimizer - INFO - Entering PerformanceOptimizer parallel_processing_context - {"max_workers": 2, "use_processes": false, "memory_optimization_mode": "normal"}
2025-06-12 21:11:52,705 - anonympdf.memory_optimizer - INFO - Garbage collection settings optimized - {"mode": "normal", "threshold_mb": 100, "time_threshold": 30}
2025-06-12 21:11:52,705 - anonympdf.memory_optimizer - INFO - Garbage collector tuned to normal mode via MemoryOptimizer.
2025-06-12 21:11:52,705 - anonympdf.memory_optimizer - INFO - Entered optimized_processing context with mode: normal
2025-06-12 21:11:52,705 - anonympdf.performance_optimizer - INFO - Exiting PerformanceOptimizer parallel_processing_context
2025-06-12 21:11:52,705 - anonympdf.memory_optimizer - INFO - Exiting optimized_processing context for mode: normal. Forcing GC.
2025-06-12 21:11:52,705 - anonympdf.memory_optimizer - INFO - Forcing garbage collection via MemoryOptimizer.
2025-06-12 21:11:53,156 - anonympdf.memory_optimizer - INFO - Garbage collection completed - {"duration_seconds": 0.38194704055786133, "memory_freed_mb": 71.78125, "objects_collected": 11748, "total_objects_after": 904039}
2025-06-12 21:11:53,156 - anonympdf.memory_optimizer - INFO - Restored original GC thresholds: (700, 10, 10)
2025-06-12 21:11:53,172 - anonympdf.performance - INFO - Performance tracking: parallel_file_processing - {"duration": 0.4665334224700928, "memory_delta": -69.12109375, "file_count": 2, "total_size_mb": 0.0, "operation_type": "parallel_file_processing", "parallel": true, "max_workers": 2}
2025-06-12 21:11:53,172 - anonympdf.performance - INFO - Parallel session completed - {"session_id": "parallel_file_processing_1749751912", "session_duration_seconds": 0.4665334224700928, "worker_count": 2, "tasks_completed": 2, "tasks_failed": 0, "total_tasks": 2, "success_rate": 1.0, "total_processing_time": 0.0, "parallel_efficiency": 0.0, "throughput_tasks_per_second": 4.286938306393709, "memory_delta_mb": -69.12109375, "avg_task_duration": 0.0}
2025-06-12 21:11:53,172 - anonympdf.performance - INFO - Batch processing completed: parallel_file_processing - {"file_count": 2, "total_size_mb": 0.0, "duration": 0.4665334224700928, "parallel": true, "throughput_tasks_per_second": 4.286938306393709}
2025-06-12 21:11:53,172 - anonympdf.performance - INFO - Parallel file processing completed - {"files_processed": 2, "results_count": 2, "duration_seconds": 0.4665334224700928, "throughput_tasks_per_second": 4.286938306393709}
_____________________ TestPerformanceOptimizedProcessor.test_single_file_processing_with_caching ______________________
tests\test_performance_enhanced.py:394: in test_single_file_processing_with_caching
    with patch.object(self.processor.cache, 'get') as mock_get, \
E   AttributeError: 'PerformanceOptimizedProcessor' object has no attribute 'cache'
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:53,218 - anonympdf.performance - INFO - Performance optimizers loaded successfully
___________________________________ TestGlobalFunctions.test_get_performance_report ___________________________________
tests\test_performance_enhanced.py:470: in test_get_performance_report
    with global_performance_monitor.track_operation("global_op") as tracker:
E   TypeError: 'dict' object does not support the context manager protocol
_________________________________ TestIntegration.test_end_to_end_parallel_processing _________________________________
tests\test_performance_enhanced.py:509: in test_end_to_end_parallel_processing
    with patch.object(processor, '_process_single_file_task', side_effect=process_file) as mock_process:
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:1446: in __enter__
    original, local = self.get_original()
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <app.core.performance.PerformanceOptimizedProcessor object at 0x00000253EB8DB910> does not have the attribute '_process_single_file_task'
__________________________________ TestIntegration.test_concurrent_metric_collection __________________________________
tests\test_performance_enhanced.py:539: in test_concurrent_metric_collection
    assert stats["total_files_processed"] >= 5 # Should be at least 5
E   KeyError: 'total_files_processed'
_____________________________________ TestIntegration.test_performance_under_load _____________________________________
tests\test_performance_enhanced.py:552: in test_performance_under_load
    with patch.object(processor, '_process_single_file_task', return_value={}) as mock_process:
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:1446: in __enter__
    original, local = self.get_original()
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <app.core.performance.PerformanceOptimizedProcessor object at 0x00000253EB8DB910> does not have the attribute '_process_single_file_task'
_____________________________________ TestIntegration.test_end_to_end_processing ______________________________________
tests\test_performance_optimizer.py:364: in test_end_to_end_processing
    assert status['status'] == 'completed'
E   AssertionError: assert 'queued' == 'completed'
E     - completed
E     + queued
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:54,290 - anonympdf.performance_optimizer - INFO - Batch submitted - {"batch_id": "end_to_end_batch", "task_count": 3, "priority": 1}
_______________________________ TestIntegration.test_performance_improvement_simulation _______________________________
tests\test_performance_optimizer.py:380: in test_performance_improvement_simulation
    assert processor.config == get_config().get('performance', {})
E   AssertionError: assert {'chunk_size'...x_workers': 4} == {'batch_engin...kers': 4, ...}
E     Omitting 1 identical items, use -vv to show
E     Left contains 1 more item:
E     {'chunk_size': 100}
E     Right contains 4 more items:
E     {'batch_engine': {'batch_timeout_seconds': 10, 'max_batch_size': 100},
E      'cache_size': 1000,
E      'cache_ttl_seconds': 3600,
E      'parallel_processing': {'chunk_size': 100, 'max_workers': 4}}
E     Use -v to get more diff
________________________________ TestAnomalyDetector.test_alert_threshold_integration _________________________________
tests\test_real_time_monitor.py:156: in test_alert_threshold_integration
    assert len(anomalies) > 0
E   assert 0 > 0
E    +  where 0 = len([])
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:54,459 - anonympdf.anonympdf.real_time_monitor - INFO - AnomalyDetector initialized with sensitivity: medium, alert_thresholds: 0
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:54,459 - anonympdf.anonympdf.real_time_monitor - INFO - Added alert threshold for test_metric
_____________________________ TestRealTimeMonitor.test_ml_monitor_callback_functionality ______________________________
tests\test_real_time_monitor.py:353: in test_ml_monitor_callback_functionality
    assert mock_system.call_count == 1
E   AssertionError: assert 0 == 1
E    +  where 0 = <MagicMock name='get_system_metrics' id='2559440897936'>.call_count
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:55,292 - anonympdf.anonympdf.real_time_monitor - INFO - AnomalyDetector initialized with sensitivity: medium, alert_thresholds: 0
2025-06-12 21:11:55,292 - anonympdf.anonympdf.real_time_monitor - INFO - PerformanceAggregator initialized
2025-06-12 21:11:55,324 - anonympdf.anonympdf.real_time_monitor - INFO - RealTimeMonitor initialized
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:11:55,324 - anonympdf.anonympdf.real_time_monitor - INFO - Registered as ML metrics callback for automatic forwarding
___________________________________ TestRealTimeMonitor.test_alert_callback_system ____________________________________
tests\test_real_time_monitor.py:452: in test_alert_callback_system
    self.monitor._process_anomaly_alerts([mock_anomaly])
app\core\real_time_monitor.py:670: in _process_anomaly_alerts
    self._store_anomaly(anomaly)
app\core\real_time_monitor.py:709: in _store_anomaly
    json.dumps(anomaly.context)
..\..\..\AppData\Local\Programs\Python\Python311\Lib\json\__init__.py:231: in dumps
    return _default_encoder.encode(obj)
..\..\..\AppData\Local\Programs\Python\Python311\Lib\json\encoder.py:200: in encode
    chunks = self.iterencode(o, _one_shot=True)
..\..\..\AppData\Local\Programs\Python\Python311\Lib\json\encoder.py:258: in iterencode
    return _iterencode(o, 0)
..\..\..\AppData\Local\Programs\Python\Python311\Lib\json\encoder.py:180: in default
    raise TypeError(f'Object of type {o.__class__.__name__} '
E   TypeError: Object of type Mock is not JSON serializable
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:11:56,512 - anonympdf.anonympdf.real_time_monitor - INFO - AnomalyDetector initialized with sensitivity: medium, alert_thresholds: 0
2025-06-12 21:11:56,512 - anonympdf.anonympdf.real_time_monitor - INFO - PerformanceAggregator initialized
2025-06-12 21:11:56,543 - anonympdf.anonympdf.real_time_monitor - INFO - RealTimeMonitor initialized
____________________________ TestTrainingDataStorage.test_save_and_load_training_examples _____________________________
tests\test_training_data_collector.py:92: in test_save_and_load_training_examples
    create_dummy_example("123 Main St", "ADDRESS", True, "doc1", source="test_source_1"),
E   TypeError: create_dummy_example() got an unexpected keyword argument 'source'
________________________________ TestTrainingDataStorage.test_get_dataset_stats_empty _________________________________
tests\test_training_data_collector.py:129: in test_get_dataset_stats_empty
    assert stats.total_samples == 0
E   AttributeError: 'NoneType' object has no attribute 'total_samples'
_________________________ TestTrainingDataCollector.test_get_balanced_training_set_with_data __________________________
tests\test_training_data_collector.py:216: in test_get_balanced_training_set_with_data
    assert stats.total_samples == 13
E   assert 6 == 13
E    +  where 6 = DatasetStats(total_samples=6, positive_samples=3, negative_samples=3, categories={}, document_types={}, date_range=(datetime.datetime(2025, 6, 12, 21, 12, 10, 136443), datetime.datetime(2025, 6, 12, 21, 12, 10, 136443)), quality_score=1.0).total_samples
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:12:10,136 - anonympdf.app.core.training_data - INFO - Created balanced training set: 6 examples
___________________________________ TestPersonNameValidation.test_length_validation ___________________________________
tests\test_validation_utils.py:58: in test_length_validation
    assert not validate_person_name("This Is A Very Long Name That Should Be Rejected")
E   AssertionError: assert not True
E    +  where True = validate_person_name('This Is A Very Long Name That Should Be Rejected')
___________________________ TestABTestManager.test_record_and_evaluate_metrics_variant_wins ___________________________
tests\adaptive\test_ab_testing.py:112: in test_record_and_evaluate_metrics_variant_wins
    self.assertEqual(result.metrics_comparison['accuracy']['winner'], 'variant')
E   KeyError: 'winner'
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:12:10,693 - anonympdf.ab_testing - INFO - Loading A/B tests from database.
2025-06-12 21:12:10,693 - anonympdf.ab_testing - INFO - Loaded 0 tests.
2025-06-12 21:12:10,693 - anonympdf.ab_testing - INFO - ABTestManager initialized with database at test_ab_manager.db.
2025-06-12 21:12:10,693 - anonympdf.ab_testing - INFO - Saving test ab_fb6d2526 to database.
2025-06-12 21:12:10,709 - anonympdf.ab_testing - INFO - Created new A/B test 'Evaluation Test' with ID ab_fb6d2526.
2025-06-12 21:12:10,709 - anonympdf.ab_testing - INFO - Saving test ab_fb6d2526 to database.
2025-06-12 21:12:10,709 - anonympdf.ab_testing - INFO - Started A/B test 'Evaluation Test' (ID: ab_fb6d2526).
C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF\venv\Lib\site-packages\scipy\stats\_axis_nan_policy.py:586: RuntimeWarning: Precision loss occurred in moment calculation due to catastrophic cancellation. This occurs when the data are nearly identical. Results may be unreliable.
  res = hypotest_fun_out(*samples, **kwds)
2025-06-12 21:12:11,079 - anonympdf.ab_testing - INFO - Database connection to test_ab_manager.db closed.
_____________________ TestOnlineLearner.test_retrain_model_saves_examples_and_triggers_retraining _____________________
tests\adaptive\test_online_learner.py:123: in test_retrain_model_saves_examples_and_triggers_retraining
    online_learner.retrain_model(sample_training_examples)
E   AttributeError: 'OnlineLearner' object has no attribute 'retrain_model'
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:12:11,281 - anonympdf.adaptive_learning.online_learner - INFO - OnlineLearner initialized.
______________________ TestOnlineLearner.test_retrain_model_saves_examples_but_skips_retraining _______________________
tests\adaptive\test_online_learner.py:134: in test_retrain_model_saves_examples_but_skips_retraining
    online_learner.retrain_model(sample_training_examples)
E   AttributeError: 'OnlineLearner' object has no attribute 'retrain_model'
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:12:11,295 - anonympdf.adaptive_learning.online_learner - INFO - OnlineLearner initialized.
_______________________________ TestPatternLearner.test_discover_and_validate_patterns ________________________________
tests\adaptive\test_pattern_learner.py:39: in test_discover_and_validate_patterns
    assert len(patterns) == 1
E   assert 0 == 1
E    +  where 0 = len([])
------------------------------------------------ Captured stderr setup ------------------------------------------------
2025-06-12 21:12:11,479 - anonympdf.app.core.adaptive.pattern_learner - INFO - PatternLearner initialized - {"min_confidence": 0.8, "min_samples": 3}
------------------------------------------------ Captured stderr call -------------------------------------------------
2025-06-12 21:12:11,479 - anonympdf.app.core.adaptive.pattern_learner - WARNING - Insufficient samples for pattern discovery. Need 3, got 1
================================================ slowest 10 durations =================================================
3.53s setup    tests/test_feedback_system.py::TestUserFeedbackProcessor::test_initialization
3.44s setup    tests/test_feedback_system.py::TestUserFeedbackProcessor::test_feedback_to_training_example_false_positive
3.36s setup    tests/test_feedback_system.py::TestUserFeedbackProcessor::test_validate_feedback_invalid
3.35s setup    tests/test_feedback_system.py::TestUserFeedbackProcessor::test_get_feedback_stats
3.32s setup    tests/test_feedback_system.py::TestFeedbackSystemIntegration::test_config_integration
3.20s setup    tests/test_feedback_system.py::TestUserFeedbackProcessor::test_should_trigger_retrain_time
3.19s setup    tests/test_feedback_system.py::TestFeedbackSystemIntegration::test_concurrent_feedback_submission
3.09s setup    tests/test_feedback_system.py::TestUserFeedbackProcessor::test_validate_feedback_valid
3.05s setup    tests/test_feedback_system.py::TestUserFeedbackProcessor::test_submit_feedback
3.00s setup    tests/test_feedback_system.py::TestFeedbackSystemIntegration::test_feedback_submission_and_processing_flow
=============================================== short test summary info ===============================================
ERROR tests/system/test_adaptive_workflow.py::test_fixture_creation - AttributeError: 'str' object has no attribute 'parent'
ERROR tests/system/test_adaptive_workflow.py::test_feedback_creates_pattern_and_overrides_prediction - AttributeError: 'str' object has no attribute 'parent'
ERROR tests/system/test_adaptive_workflow.py::test_ab_testing_full_lifecycle - AttributeError: 'str' object has no attribute 'parent'
FAILED tests/test_analytics_engine.py::TestQualityInsightsGenerator::test_generate_report_with_insights - AssertionError: assert ('summary' in {'insights': [], 'quality_summary': {'by_category': {'EMAIL': {'avg_confidence...
FAILED tests/test_config_manager.py::TestConfigManager::test_configuration_validation - assert False is True
FAILED tests/test_feedback_system.py::TestFeedbackSystemIntegration::test_feedback_submission_and_processing_flow - AttributeError: <app.core.training_data.TrainingDataCollector object at 0x0000025394CA4E50> does not have the attri...
FAILED tests/test_intelligent_cache.py::TestIntelligentCache::test_comprehensive_stats - KeyError: 'general'
FAILED tests/test_intelligent_cache.py::TestConcurrency::test_thread_safety - KeyError: 'general'
FAILED tests/test_memory_optimizer.py::TestIntegration::test_memory_threshold_handling - AssertionError: MemoryMonitor should log a warning for high memory usage
FAILED tests/test_morning_ses5_improvements.py::TestMorningSes5AntiOverredaction::test_no_preserve_pii_in_technical_sections - AssertionError: assert not True
FAILED tests/test_morning_ses5_improvements.py::TestMorningSes5Integration::test_comprehensive_lithuanian_document_processing - KeyError: 'names'
FAILED tests/test_morning_ses5_improvements.py::TestMorningSes5Integration::test_anti_overredaction_in_technical_context - KeyError: 'names'
FAILED tests/test_pdf_processor.py::test_find_personal_info - TypeError: unhashable type: 'list'
FAILED tests/test_pdf_processor.py::test_generate_redaction_report - TypeError: unhashable type: 'list'
FAILED tests/test_pdf_processor.py::test_process_pdf_failure_on_invalid_content - AssertionError: assert 'Failed to open document' in 'An exception occurred during anonymization'
FAILED tests/test_performance_enhanced.py::TestPerformanceOptimizedProcessor::test_processor_initialization - AttributeError: 'PerformanceOptimizedProcessor' object has no attribute 'parallel_processor'
FAILED tests/test_performance_enhanced.py::TestPerformanceOptimizedProcessor::test_optimized_processing_session - AttributeError: 'PerformanceOptimizedProcessor' object has no attribute 'create_session'
FAILED tests/test_performance_enhanced.py::TestPerformanceOptimizedProcessor::test_parallel_file_processing - AssertionError: Expected 'map' to have been called once. Called 0 times.
FAILED tests/test_performance_enhanced.py::TestPerformanceOptimizedProcessor::test_single_file_processing_with_caching - AttributeError: 'PerformanceOptimizedProcessor' object has no attribute 'cache'
FAILED tests/test_performance_enhanced.py::TestGlobalFunctions::test_get_performance_report - TypeError: 'dict' object does not support the context manager protocol
FAILED tests/test_performance_enhanced.py::TestIntegration::test_end_to_end_parallel_processing - AttributeError: <app.core.performance.PerformanceOptimizedProcessor object at 0x00000253EB8DB910> does not have the...
FAILED tests/test_performance_enhanced.py::TestIntegration::test_concurrent_metric_collection - KeyError: 'total_files_processed'
FAILED tests/test_performance_enhanced.py::TestIntegration::test_performance_under_load - AttributeError: <app.core.performance.PerformanceOptimizedProcessor object at 0x00000253EB8DB910> does not have the...
FAILED tests/test_performance_optimizer.py::TestIntegration::test_end_to_end_processing - AssertionError: assert 'queued' == 'completed'
FAILED tests/test_performance_optimizer.py::TestIntegration::test_performance_improvement_simulation - AssertionError: assert {'chunk_size'...x_workers': 4} == {'batch_engin...kers': 4, ...}
FAILED tests/test_real_time_monitor.py::TestAnomalyDetector::test_alert_threshold_integration - assert 0 > 0
FAILED tests/test_real_time_monitor.py::TestRealTimeMonitor::test_ml_monitor_callback_functionality - AssertionError: assert 0 == 1
FAILED tests/test_real_time_monitor.py::TestRealTimeMonitor::test_alert_callback_system - TypeError: Object of type Mock is not JSON serializable
FAILED tests/test_training_data_collector.py::TestTrainingDataStorage::test_save_and_load_training_examples - TypeError: create_dummy_example() got an unexpected keyword argument 'source'
FAILED tests/test_training_data_collector.py::TestTrainingDataStorage::test_get_dataset_stats_empty - AttributeError: 'NoneType' object has no attribute 'total_samples'
FAILED tests/test_training_data_collector.py::TestTrainingDataCollector::test_get_balanced_training_set_with_data - assert 6 == 13
FAILED tests/test_validation_utils.py::TestPersonNameValidation::test_length_validation - AssertionError: assert not True
FAILED tests/adaptive/test_ab_testing.py::TestABTestManager::test_record_and_evaluate_metrics_variant_wins - KeyError: 'winner'
FAILED tests/adaptive/test_online_learner.py::TestOnlineLearner::test_retrain_model_saves_examples_and_triggers_retraining - AttributeError: 'OnlineLearner' object has no attribute 'retrain_model'
FAILED tests/adaptive/test_online_learner.py::TestOnlineLearner::test_retrain_model_saves_examples_but_skips_retraining - AttributeError: 'OnlineLearner' object has no attribute 'retrain_model'
FAILED tests/adaptive/test_pattern_learner.py::TestPatternLearner::test_discover_and_validate_patterns - assert 0 == 1
================================= 33 failed, 318 passed, 3 errors in 90.44s (0:01:30) =================================
(venv) PS C:\Users\tomas\Desktop\0001 DUOMENU ANALITIKA\038_AnonymPDF>